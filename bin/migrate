#!/usr/bin/env node

var debug = require('debug')('ioc-migrate')
var fs = require('fs')
var path = require('path')
var program = require('commander')

var packageJson = require('../package.json')
var runner = require('../lib/runner')(fs).run
var getAppAdapter = require('../lib/getAppAdapter')

program
  .version(packageJson.version)
  .option('-c, --configFile', 'Path to your app\'s migration config file (default: /path/to/app/schema/iocmigrateConfig.js)')
  .option('-d, --direction', 'The direction in which to run the migrations.')
  .option('-v, --verbose', 'Turn on verbose mode')
  .parse(process.argv)

var log = program.verbose ? console.log : debug
var migrateConfigPath = (typeof(program.configFile) === 'undefined' ? path.join(process.cwd(), 'schema', 'iocmigrateConfig.js') : program.configFile).replace('.js', '')
var direction = typeof(program.direction) === 'undefined' ? 'up' : program.direction.toLowerCase()

if ('up' !== direction && 'down' !== direction) {
  console.error('OOPS! You specified an invalid migration direction:', program.direction)
}

runner(
  getAppAdapter(migrateConfigPath)
, log
, { direction: direction }
, function allDone(err, results) {
    if (err) {
      console.error(err)
    } else {
      console.log(results)
    }
  }
)
